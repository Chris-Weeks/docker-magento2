#!/usr/bin/env bash
set -o errexit

MEM=$(docker info | grep "Total Memory" | cut -d':' -f2 | xargs | sed s/GiB//)
# Docker reports RAM 0.2 less than what it is actually set to
(( $(echo "$MEM < 5.7" | bc -l) )) && echo "There must be at least 6GB of RAM allocated to Docker to continue." && exit

if [ "$1" == "--no-dev" ]; then
  bin/docker-compose --no-dev up -d --remove-orphans "${@:2}"
  exit $?
fi

# Check if volume files exist to avoid creating an empty folder
VOLUME_LIST=$(bin/yq '.services.app.volumes[]' ./compose.dev.yaml | cut -d ':' -f1)
IGNORE_LIST="./src/app/code ./src/m2-hotfixes ./src/patches ./src/var/log ./src/var/report ./src"
IS_VALID=true

# Loop through all files missing from the compose.dev.yaml file
for file in $VOLUME_LIST; do
  if [[ ! -e $file && " $IGNORE_LIST " != *" $file "* ]]; then
    echo "$file: No such file or directory"
    IS_VALID=false
  fi
done

# Wait to exit until all missing files have been outputted to the user
[ $IS_VALID = false ] && echo "Failed to start docker for missing volume files" && exit

bin/docker-compose up -d --remove-orphans "$@"

## Blackfire support
## ------------------
## First register the blackfire agent with:
#bin/root blackfire-agent --register --server-id={YOUR_SERVER_ID} --server-token={YOUR_SERVER_TOKEN}
## Then uncomment the below line (and leave uncommented) to start the agent automatically with bin/start:
#bin/root /etc/init.d/blackfire-agent start

bin/cache-clean --watch
