#!/usr/bin/env bash
set -o errexit

DOMAIN=${1:-magento.test}

# shellcheck source=../env/db.env
source env/db.env
# shellcheck source=../env/elasticsearch.env
source env/elasticsearch.env
# shellcheck source=../env/opensearch.env
source env/opensearch.env
# shellcheck source=../env/magento.env
source env/magento.env
# shellcheck source=../env/rabbitmq.env
source env/rabbitmq.env
# shellcheck source=../env/redis.env
source env/redis.env

bin/clinotty bin/magento setup:install \
  --db-host="$MYSQL_HOST" \
  --db-name="$MYSQL_DATABASE" \
  --db-user="$MYSQL_USER" \
  --db-password="$MYSQL_PASSWORD" \
  --base-url=https://"$DOMAIN"/ \
  --base-url-secure=https://"$DOMAIN"/ \
  --backend-frontname="$MAGENTO_ADMIN_FRONTNAME" \
  --admin-firstname="$MAGENTO_ADMIN_FIRST_NAME" \
  --admin-lastname="$MAGENTO_ADMIN_LAST_NAME" \
  --admin-email="$MAGENTO_ADMIN_EMAIL" \
  --admin-user="$MAGENTO_ADMIN_USER" \
  --admin-password="$MAGENTO_ADMIN_PASSWORD" \
  --language="$MAGENTO_LOCALE" \
  --currency="$MAGENTO_CURRENCY" \
  --timezone="$MAGENTO_TIMEZONE" \
  --amqp-host="$RABBITMQ_HOST" \
  --amqp-port="$RABBITMQ_PORT" \
  --amqp-user="$RABBITMQ_DEFAULT_USER" \
  --amqp-password="$RABBITMQ_DEFAULT_PASS" \
  --amqp-virtualhost="$RABBITMQ_DEFAULT_VHOST" \
  --cache-backend="$CACHE_BACKEND" \
  --cache-backend-redis-server="$CACHE_BACKEND_REDIS_SERVER" \
  --cache-backend-redis-db="$CACHE_BACKEND_REDIS_DB" \
  --page-cache="$PAGE_CACHE" \
  --page-cache-redis-server="$PAGE_CACHE_REDIS_SERVER" \
  --page-cache-redis-db="$PAGE_CACHE_REDIS_DB" \
  --session-save="$SESSION_SAVE" \
  --session-save-redis-host="$SESSION_SAVE_REDIS_HOST" \
  --session-save-redis-log-level="$SESSION_SAVE_REDIS_LOG_LEVEL" \
  --session-save-redis-db="$SESSION_SAVE_REDIS_DB" \
  --session-save-redis-disable-locking="$SESSION_SAVE_REDIS_DISABLE_LOCKING" \
  --search-engine=opensearch \
  --elasticsearch-host="$ES_HOST" \
  --elasticsearch-port="$ES_PORT" \
  --opensearch-host="$OPENSEARCH_HOST" \
  --opensearch-port="$OPENSEARCH_PORT" \
  --use-rewrites=1 \
  --no-interaction
